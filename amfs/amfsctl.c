#include <sys/ioctl.h>
#include <stdio.h>
#include <fcntl.h>
#include <unistd.h>
#include <ctype.h>
#include <stdlib.h>
#include <string.h>
             
#define AMFS_IOCADD  _IOW(AMFS_MAGIC, 2 , char *)    
#define AMFS_MAGIC 's'
#define AMFS_IOCREM _IOW(AMFS_MAGIC, 3 , char *)
#define AMFS_IOCLISTLEN _IOR(AMFS_MAGIC, 4 , int*)
#define AMFS_IOCLIST _IOR(AMFS_MAGIC, 5 , char*)



int printHelp()
{
    printf("amfsctl Usage\n");
    printf("To list known patterns: ./amfsctl -l /mnt/amfs\n");
    printf("To add new pattern: ./amfsctl -a \"newpatt\" /mnt/amfs\n");
    printf("To remove an old pattern: ./amfsctl -r \"oldpatt\" /mnt/amfs\n");

    return(0);
}


int main(int argc, char** argv)
{
  
    int option  = -1, listPatterns = 0, isAppend = 0, doRemove = 0, ret = 0;
    char* pattern;


    while ((option = getopt (argc, argv, "a:r:lh")) != -1)
   {
      switch(option)
      {
         case 'a':
                  pattern = strdup(optarg);
                  isAppend = 1;
                  break;
         case 'r':
                  pattern = strdup(optarg);
                  doRemove = 1;
                  break;
         case 'l':
                  if(listPatterns == 0)
                  {
                      listPatterns = 1;
                  }
                  else
                     return printHelp();
                  break;

         case 'h':
                  return printHelp();
         case '?':
                  if (optopt == 'a')
                    printf ("Option -a requires an argument.\n");
                  else if (optopt == 'r')
                    printf ("Option -r requires an argument.\n");
                  return printHelp();
         default:
                  return printHelp();

      }

    }

    if(argc-optind != 1)
    {
       return printHelp();
    }

    const char* mountPoint = argv[optind];
    int fd;
    fd = open("/mnt/amfs", O_RDONLY);

    if(isAppend)
    {
       printf("Add patt: %s\n", pattern);
       ret = ioctl(fd, AMFS_IOCADD, pattern);

    }else if(doRemove)
    {
        printf("Remove patt: %s\n", pattern);
        ret = ioctl(fd, AMFS_IOCREM, pattern);
    }else
    {
       printf("list pattrn");
       // get the count
       int patbufSize = 0, i = 0;
       ret = ioctl(fd, AMFS_IOCLISTLEN, &patbufSize);
       printf(" pattern buffer size: %d\n", patbufSize);
       char* patterns = (char*) malloc(patbufSize);
       ioctl(fd, AMFS_IOCLIST, patterns);
       for(i = 0;i < patbufSize; i++)
            printf("%c", patterns[i]);
    }
    
    printf("mountpoint: %s", mountPoint);
    printf(" return from ioctl: %d", ret);
    
    return 0;
}
